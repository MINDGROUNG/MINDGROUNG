<!DOCTYPE html>
<html lang="ko">
    <head>
        <%- include ./common/commonHead.html%>
        <!--공통타이틀로 적용 할 경우 commonHead 안에 넣기-->
    </head>
    <body>
        <div class="wrap setting">
            <%- include ./common/commonHeader.html%>
            <!-- 호스트스튜디오 기본 사이드네비 -->
            <div class="settingNavWrap">
                <div class="top">
                    <h4 class="navTitle">
                        <%=translation.loginAndJoin.Setting%>
                    </h4>
                    <div class="nav">
                        <div class="mo-nav-title">
                            <h5><%=translation.setting.Account_Setting%></h5>
                            <img src="/web/img/ICN_EXPAND.png" alt="">
                        </div>
                        <ul class="nav-Btns settingPageNav">
                            <li>
                                <button class="active" data-tab="accountSetting">
                                    <h5><%=translation.setting.Account_Setting%></h5>
                                </button>
                            </li>
                            <li>
                                <button data-tab="generalSetting">
                                    <h5><%=translation.setting.General_Settings%></h5>
                                </button>
                            </li>
                            <li>
                                <button data-tab="privacySetting">
                                    <h5><%=translation.setting.Privacy_Setting%></h5>
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- 세팅 화면들 -->
            <section class="settingContentsMain">
                <article class="accountSetting active commonSettingPage">
                    <%- include ./settingAccountPrivacySetting.html%>
                </article>
                <article class="generalSetting commonSettingPage">
                    <%- include ./settingGeneralSetting.html%>
                </article>
                <article class="privacySetting commonSettingPage">
                    <%- include ./settingPrivacySetting.html%>
                </article>
            </section>
            <%- include ./common/commonScript.html%> <%- include ./common/commonFooter.html%>
        </div>
        <script>

            //화면사이즈별 overflow값 수정
            //푸터 화면별 show, hide
            $(window).on('resize load', function() {
                if($(this).innerWidth() <= 1279)
                {
                    $('.setting').css('overflow-x', 'hidden');
                    $('.footerWrap').show();
                }
                else
                {
                    $('.setting').css('overflow-x', 'unset');
                    $('.footerWrap').hide();
                }
            })

            //세팅nav 탭온오프, 페이지온오프
            $('.settingPageNav button').click(function() {
                $('.settingPageNav button').removeClass('active');
                $(this).addClass('active');
                $('.commonSettingPage').each(function(){
                    $(this).removeClass('active');
                })
                $('.'+$(this).data('tab')+'').addClass('active');

                //모바일에선 탭 이름 위로 올리기
                var tabName = $(this).children('h5').text();
                $('.mo-nav-title').children('h5').text(tabName);
                $('.mo-nav-title').removeClass('active');
                $('.nav-Btns').removeClass('active');
            })

            //푸터 화면별 show, hide
            // $(window).on('resize load', function() {
            //     if($(this).innerWidth() <= 1279)
            //     {
            //         $('.footerWrap').show();
            //     }
            //     else
            //     {
            //         $('.footerWrap').hide();
            //     }
            // })

            //셀렉박스 열기실행
            window.addEventListener('click', openGenderBox)
            window.addEventListener('click', openRegionBox)

            //성별셀렉박스 열기
            function openGenderBox(e) {
                var privacyGender = document.getElementById('privacyGender');
                var privacyGenderBox = document.querySelector('.privacyGenderBox');
                if(e.target != privacyGender)
                {
                    privacyGenderBox.classList.remove('active');
                }
                
            }
            
            //지역셀렉박스열기
            function openRegionBox(e) {
                var privacyRegionCategory = document.getElementById('privacyRegionCategory');
                var privacyRegionBox = document.querySelector('.privacyRegionBox');
                if(e.target != privacyRegionCategory)
                {
                    privacyRegionBox.classList.remove('active');
                }
            }

            //성별값 가져오기
            function selectValue(e) {
                var genderCustomInput = document.querySelector('.genderCustomInput');
                var basicInfoCustomGender = document.getElementById('basicInfoCustomGender');
                privacyGender.value = e.value;
                privacyGender.style.color = '#fff';
                var isGenderCustom = $('input:radio[name="privacyGenderSelect"]:checked').val();
                console.log("isGenderCustom"+ isGenderCustom);
                if(isGenderCustom == "custom" || isGenderCustom == "사용자 지정")
                {
                    $('.genderCustomInput').removeClass('hidden');
                }
                else
                {
                    $('.genderCustomInput').addClass('hidden');
                }
            }

            //지역값넣기
            function selectRegion(e) {
                var privacyRegionCategory = document.getElementById('privacyRegionCategory');
                privacyRegionCategory.value = e.value;
                privacyRegionCategory.style.color = '#fff';
            }

            $(function() {
                //지역들 배열에 넣기
                var privacyRegions = [
                    '<%=translation.loginAndJoin.North_America%>',
                    '<%=translation.loginAndJoin.South_America%>',
                    '<%=translation.loginAndJoin.Central_America%>',
                    '<%=translation.loginAndJoin.Caribbean%>',
                    '<%=translation.loginAndJoin.Central_South_Asia%>',
                    '<%=translation.loginAndJoin.Northeastern_Asia%>',
                    '<%=translation.loginAndJoin.Southeastern_Asia%>',
                    '<%=translation.loginAndJoin.Australia_Oceania%>',
                    '<%=translation.loginAndJoin.Northern_Europe%>',
                    '<%=translation.loginAndJoin.Southern_Europe%>',
                    '<%=translation.loginAndJoin.Eastern_Europe%>',
                    '<%=translation.loginAndJoin.Western_Europe%>',
                    '<%=translation.loginAndJoin.Middle_East%>',
                    '<%=translation.loginAndJoin.Northern_Africa%>',
                    '<%=translation.loginAndJoin.Southern_Africa%>'
                ]
                //지역들 넣기
                for(var i = 0; i < privacyRegions.length; i++) 
                {
                    var regionsSeletOption = 
                    '<li>' +
                    '<input type="radio" value="'+privacyRegions[i]+'" id="'+privacyRegions[i]+'" name="regionsSelect" onclick="selectRegion(this)">' +
                    '<label for="'+privacyRegions[i]+'">' +
                    '<span>'+privacyRegions[i]+'</span>' +
                    '</label>'
                    '</li>'
                    $('.privacyRegionBox').append(regionsSeletOption);
                }

                //공개범위 셀렉박스
                $('.stateBtn > button').click(function() {
                    $(this).next('.hdnBtns').toggleClass('active');
                    
                })

                //general setting 페이지 언어 선택
                $('.selectHere .arrow').on('click',function()
                {
                    $('.choiceLanguage').fadeToggle(300);
                });

                //모바일전용 네비 메뉴열기
                $('.mo-nav-title').click(function() {
                    $(this).next('.nav-Btns').toggleClass('active');
                    $(this).toggleClass('active');
                }); 
                
                

            });



            function pwdChange(){
                var pwCheck = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/;

                if(pwCheck.test(document.getElementById('settingNewPwd').value)) {
                    if(document.getElementById('settingReEnterPwd').value != document.getElementById('settingNewPwd').value) {
                        alert('새로 변경하는 비밀번호가 일치하지 않습니다.');
                        return false;
                    }
                } else {
                    alert('대소문자를 포함한 8자 이상으로 입력해주세요.');
                    return false;
                }

                var jsonObject = {};
                jsonObject.protocol = 'pwCheck';
                jsonObject.userEmail = user.userEmail;
                jsonObject.pwd = SHA256(document.getElementById('settingCurrentPwd').value)
                protocolSendAjaxWithCallBack(jsonObject, function(result){
                    if(result.resultCode==0){
                        var sendJsonObject ={};
                        sendJsonObject.protocol='changePw';
                        sendJsonObject.userEmail = user.userEmail;
                        sendJsonObject.newPw = SHA256(document.getElementById('settingNewPwd').value);
                        protocolSendAjaxWithCallBack(sendJsonObject, function(result){
                            alert('비밀번호가 변경되었습니다');
                            location.reload();
                    })
                    }else{
                        document.getElementById('noMatchPwdSpanID').style.display = 'block';
                        alert('비밀번호가 맞지 않습니다.');
                    }
                })
               
            }

            
    function updateUserSettings(){
        var jsonObject = {};
        var checkName = /^[a-zA-Z ]+$/;

        if(!checkName.test($("input[name=userName]").val())) {
            alert('영문 입력만 가능합니다.');
            return false;
        }

        // 이름
        var userName = $("input[name=userName]").val();
        // 생일, 성별
        var userBirth = document.getElementById("Year").value+'/'+('0' + document.getElementById("Month").value).slice(-2)+'/'+('0' + document.getElementById("Day").value).slice(-2);
        var userGender = $("input[name=privacyGenderSelect]:checked").val();
        // 자기소개
        var userBIO = $('#userBIO').val();
        // 국적, 주소
        var userRegion = $("input[name=regionsSelect]:checked").val();
        var location = document.getElementById('privacyRegionCategory').value;
        var country = document.getElementById('userCountry').value;
        var state = document.getElementById('userState').value;
        var city = document.getElementById('userCity').value;
        var streetAddress = document.getElementById('userStreetAddress').value;

        if(document.getElementById('uploadProfileImg').files.length > 0)
        {
            jsonObject.thumbNail = saveFileToServer('uploadProfileImg').filePath;
        }

        jsonObject.protocol = 'updateSetting';
        jsonObject.userName = userName;
        jsonObject.birth = userBirth;
        jsonObject.gender = userGender;
        jsonObject.userBio = userBIO;
        jsonObject.region = userRegion;
        jsonObject.location = location;
        jsonObject.country = country;
        jsonObject.state = state;
        jsonObject.city = city;
        jsonObject.streetAddress = streetAddress;

            
       
        protocolSendAjaxWithCallBack(jsonObject, function(result) 
        {
            if(result.resultCode == 0)
            {
                alert('저장되었습니다.');
                window.location.href="/setting";      
                console.log(jsonObject);         
            }
            else
            {
                alert(result.message);
            }
        });
    }

    function deleteAccount(){
        //삭제 확인 추가 필요
        var jsonObject = {};
        jsonObject.protocol = 'deleteAccount';

        protocolSendAjaxWithCallBack(jsonObject, function(result){

            window.location.href = "/";
        });
    }
    

            var user = <%-user ? JSON.stringify(user) : {}%>;


        </script>
    </body>
</html>
